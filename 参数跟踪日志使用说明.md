# 参数跟踪日志使用说明

## 概述

为了更好地调试和排查问题，我们为日志系统添加了参数跟踪功能。这个功能可以直观地显示每个函数调用时参数的传递情况，帮助快速定位问题所在。

## 新增的日志方法

### 1. `trackParams` - 通用参数跟踪

用于跟踪函数参数传递情况，适用于大多数场景。

```typescript
import { logger } from '@services/logger';

// 异步版本
const result = await logger.trackParams(
  'functionName',           // 函数名称
  {                        // 参数对象
    param1: value1,
    param2: value2,
    param3: value3
  },
  async (validParams) => {   // 执行函数，只包含有效参数
    // 你的业务逻辑
    return await someApi(validParams.param1, validParams.param2);
  }
);

// 同步版本
const result = logger.trackParamsSync(
  'functionName',
  { param1: value1, param2: value2 },
  (validParams) => {
    // 同步业务逻辑
    return someSyncFunction(validParams.param1);
  }
);
```

### 2. `trackApiParams` - API调用专用跟踪

专门用于API调用的参数跟踪，包含网络相关的诊断信息。

```typescript
const result = await logger.trackApiParams(
  'apiFunctionName',         // API函数名
  'https://api.example.com', // API地址
  {                         // 请求参数
    url: 'https://api.example.com',
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: { data: 'example' },
    cred: credentials,
    token: authToken
  },
  async (validParams) => {   // API调用逻辑
    const response = await fetch(validParams.url, {
      method: validParams.method,
      headers: validParams.headers,
      body: JSON.stringify(validParams.body)
    });
    return response.json();
  }
);
```

## 日志输出示例

### 成功情况
```
参数检查 [fetchSklandCred] {
  functionName: "fetchSklandCred",
  totalParams: 3,
  validParams: 2,
  invalidParams: 1,
  paramDetails: {
    hgToken: { value: "[已设置]", isValid: true, type: "string" },
    isCredReady: { value: false, isValid: true, type: "boolean" },
    lastUpdated: { value: 0, isValid: true, type: "number" }
  },
  validParamNames: ["hgToken", "isCredReady", "lastUpdated"],
  invalidParamDetails: {}
}

[fetchSklandCred] 参数传递成功 {
  functionName: "fetchSklandCred",
  duration: "1234.56ms",
  usedParams: ["hgToken", "isCredReady", "lastUpdated"],
  success: true,
  result: "[Object]"
}
```

### 参数缺失情况
```
[getGachaHistory] 所有参数都无效或为空 {
  functionName: "getGachaHistory",
  params: {
    uid: { value: null, isValid: false, type: "undefined" },
    cookie: { value: null, isValid: false, type: "undefined" },
    token: { value: "", isValid: false, type: "string", isEmpty: true }
  },
  suggestion: "请检查参数传递是否正确"
}
```

### API调用失败情况
```
[getGachaHistory] API调用失败 {
  apiName: "getGachaHistory",
  url: "https://ak.hypergryph.com/user/api/inquiry/gacha/history",
  duration: "5678.90ms",
  error: {
    message: "HTTP 401: Unauthorized",
    name: "Error",
    stack: "Error: HTTP 401: Unauthorized..."
  },
  paramStatus: {
    uid: { value: "12345", isValid: true, type: "string" },
    cookie: { value: "[已设置]", isValid: true, type: "string" },
    token: { value: null, isValid: false, type: "undefined" }
  },
  validParams: ["uid", "cookie"],
  invalidParams: ["token"],
  networkDiagnostics: {
    checkConnection: "网络连接是否正常",
    checkEndpoint: "API端点 https://ak.hypergryph.com/user/api/inquiry/gacha/history 是否可访问",
    checkAuth: "认证信息是否有效",
    checkCORS: "是否存在CORS问题",
    checkTimeout: "是否超时",
    checkRateLimit: "是否触发频率限制"
  },
  paramFixSuggestions: [
    "token参数缺失：请检查登录状态和令牌有效性"
  ]
}
```

## 参数状态说明

每个参数都会被分析并显示以下信息：

- `value`: 参数值（敏感信息会被隐藏）
- `isValid`: 参数是否有效（非null、非undefined、非空字符串）
- `type`: 参数类型（string、number、boolean、object、array）
- `isEmpty`: 是否为空值（空字符串或空数组）

## 错误诊断功能

当API调用失败时，日志会提供：

1. **参数状态分析**：显示哪些参数有效，哪些无效
2. **网络诊断建议**：提供网络相关的检查项
3. **参数修复建议**：针对缺失的关键参数提供具体修复建议

## 使用建议

### 1. 关键API调用
对于所有关键的API调用，都应使用`trackApiParams`：

```typescript
// 推荐：使用参数跟踪
export const getUserData = async (userId: string, token: string) => {
  return await logger.trackApiParams(
    'getUserData',
    `${API_BASE}/user/${userId}`,
    { userId, token, url: `${API_BASE}/user/${userId}`, method: 'GET' },
    async (params) => {
      const response = await fetch(params.url, {
        method: params.method,
        headers: { 'Authorization': `Bearer ${params.token}` }
      });
      return response.json();
    }
  );
};

// 不推荐：直接调用
export const getUserData = async (userId: string, token: string) => {
  const response = await fetch(`${API_BASE}/user/${userId}`, {
    headers: { 'Authorization': `Bearer ${token}` }
  });
  return response.json();
};
```

### 2. 复杂业务逻辑
对于复杂的业务逻辑函数，使用`trackParams`：

```typescript
export const processGameData = async (gameData: any, userConfig: any, options: any) => {
  return await logger.trackParams(
    'processGameData',
    { gameData, userConfig, options },
    async (validParams) => {
      // 处理逻辑
      const processedData = transformData(validParams.gameData);
      const config = mergeConfig(validParams.userConfig, validParams.options);
      return saveData(processedData, config);
    }
  );
};
```

### 3. 敏感信息处理
系统会自动隐藏敏感信息：

- `password`: 显示为 `[已隐藏]`
- `token`: 只显示前20个字符 + `...`
- `cookie`: 显示为 `[已设置]` 或 `null`

## 日志级别说明

- **参数检查**: INFO级别，显示参数分析结果
- **成功**: INFO级别，参数传递成功
- **警告**: WARN级别，参数缺失或无效
- **错误**: ERROR级别，API调用失败
- **API检查**: INFO级别，API参数检查
- **API成功**: INFO级别，API调用成功
- **API失败**: ERROR级别，API调用失败

## 最佳实践

1. **统一使用**: 在项目中统一使用参数跟踪，保持日志格式一致
2. **合理命名**: 函数名要清晰，便于在日志中识别
3. **参数完整**: 传递所有相关参数，让日志系统进行分析
4. **错误处理**: 配合try-catch使用，提供完整的错误信息
5. **定期检查**: 定期查看日志，及时发现潜在问题

## 注意事项

1. 参数跟踪会增加一些性能开销，建议在关键路径使用
2. 敏感信息会自动隐藏，但要注意不要在参数名中包含敏感信息
3. 在生产环境中，可以根据需要调整日志级别
4. 参数对象要使用普通对象，不要使用Map、Set等特殊类型

通过使用这些参数跟踪功能，你可以更快速地定位和解决问题，特别是在调试复杂的API调用链时。